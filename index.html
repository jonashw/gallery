<!DOCTYPE HTML>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Gallery</title>
	<script type="text/javascript" src="../core/jQuery.js"></script>	
	<script type="text/javascript" src="../core/JavaScript-load-image.js"></script>	
	<script>
		$(function(){
			//initialize the image pool from the DOM.  hide all original images
			$imageContainer.appendTo($(document.body));
			$('img').each(function(){
				var $i = $(this);
				var image = new Image();
				image.src = $i.attr('src');
				images.push($(image));
				$i.remove();
			});
			//window resize listener -> image best-fit
			$(window).on('resize',function(){
				if (current_image) bestFitCurrentImage();
			});
		});
		//settings (later moved to a public constructor)
		var wrap_mode = true;
		//core data
		var images = [];
		var current_index = 0;
		var current_image;
		var is_zoomed = false;
		var is_open = false;
		var $imageContainer = $("<div></div>").addClass('imageContainer');
		//core methods
		function nextImage(){
			if (!canNext()) return false;
			current_index++;
			if(current_index >= images.length) current_index = 0;
			loadImageFromIndex();
		}
		function prevImage(){
			if (!canPrev()) return false;
			current_index--;
			if(current_index < 0) current_index = images.length - 1;
			loadImageFromIndex();
		}
		function loadImageFromIndex(){
			if(current_image) current_image.detach();
			current_image = images[current_index];
			current_image.appendTo($imageContainer);	
			bestFitCurrentImage();
			$imageContainer.trigger('imageLoaded',current_image);
		}
		function open(){
			loadImageFromIndex();
			$imageContainer.trigger('viewerOpened');
			is_open = true;
		}
		function close(){
			if(current_image) current_image.detach();
			$imageContainer.trigger('viewerClosed');
			is_open = false;
		}
		function bestFitCurrentImage(){
			var wh = $(window).height();
			var ww = $(window).width();
			//scale the image to fit the available space
			current_image.css({
				'max-width': ww + 'px',
				'max-height': wh + 'px'
			});
			//center the image horizontally and/or vertically
			var ih = current_image.height()
			var iw = current_image.width()
			current_image.css({
				'position': 'absolute',
				'left': (ww - iw) / 2 + 'px',
				'top': (wh - ih) /2 + 'px'
			});
			is_zoomed = false;
		}
		function zoomCurrentImage(){
			if(!current_image) return false;
			current_image.removeAttr('style');
			is_zoomed = true;
		}
		function unzoomCurrentImage(){
			if(!current_image) return false;
			bestFitCurrentImage();
			is_zoomed = false;
		}
		function setWrapAround(bool){
			wrap_mode = bool;
		}
		function canWrap(){
			return wrap_mode;
		}
		function isOpen(){
			return is_open;
		}
		function canZoom(){
			return !is_zoomed && is_open;
		}
		function canUnzoom(){
			return is_zoomed && is_open;
		}
		function canNext(){
			return is_open && (canWrap() || hasNext()); 
		}
		function hasNext(){
			return current_index + 1 < images.length;
		}
		function canPrev(){
			return is_open && (canWrap() || hasPrev()); 
		}
		function hasPrev(){
			return (current_index - 1) >= 0 && images.length;
		}
		function canOpen(){
			return !is_open;
		}
		function canClose(){
			return is_open;
		}
		//example UI stuff (should remain separate from core)
		$(function(){
			var openBtn = $("#open");
			var closeBtn = $("#close");
			var prevBtn = $("#prev");
			var nextBtn = $("#next");
			var zoomBtn = $("#zoom");
			var unzoomBtn = $("#unzoom");
			var hud = $("#hud").hide();
			var wrapCheck = $("#wrap");
			updateUIState();
			openBtn.on('click',function(){
				if(!canOpen()) return false;
				open();
				updateUIState();
			});
			closeBtn.on('click',function(){
				if(!canClose()) return false;
				close();
				updateUIState();
			});
			prevBtn.on('click',function(){
				if(!canPrev()) return false;
				prevImage();
				updateUIState();
			});
			nextBtn.on('click',function(){
				if(!canNext()) return false;
				nextImage();
				updateUIState();
			});
			zoomBtn.on('click',function(){
				if(!canZoom()) return false;
				zoomCurrentImage();
				updateUIState();
			});
			unzoomBtn.on('click',function(){
				if(!canUnzoom()) return false;
				unzoomCurrentImage();
				updateUIState();
			});
			wrapCheck.on('change',function(){
				setWrapAround($(this).is(':checked'));
				updateUIState();
			});
			$imageContainer
				.on('imageLoaded',function(e,image){
					console.log(image);
					hud.text((current_index + 1) + ' of ' + images.length);
					updateUIState();
				})
				.on('click','img',function(e){
					if(is_zoomed){
						if(!canUnzoom()) return false;
						unzoomCurrentImage();	
						updateUIState();
					} else {
						if(!canZoom()) return false;
						zoomCurrentImage();
						updateUIState();
					}
				})
			;
			//keyboard navigation listener (arrow keys)
			$(document).on('keydown',function(e){
				console.log(e.which);
				switch(e.which){
					case 39://right
						if(!canNext()) return;
						nextImage();
						e.preventDefault();
						updateUIState();
						break;
					case 37: //left
						if(!canPrev()) return;
						prevImage();
						e.preventDefault();
						updateUIState();
						break;
					case 38: //up	
						if(!canZoom()) return;
						zoomCurrentImage();	
						updateUIState();
						break;
					case 40: //down
						if(!canUnzoom()) return;
						unzoomCurrentImage();	
						updateUIState();
						break;
					case 27: //esc
						if(!canClose()) return;
						close();
						updateUIState();
						break;
				}

			})
			//core UI functions
			function setEnabledTo($el,b){
				if(b){
					$el.removeAttr('disabled');
				} else {
					$el.attr('disabled','true');
				}
			}
			function setShownTo($el,b){
				if(b){
					$el.show();
				} else {
					$el.hide();
				}
			}
			function setChecked($el,b){
				if(b){
					$el.prop('checked',true);
				} else {
					$el.prop('checked',false);
				}
			}
			function updateUIState(){
				setEnabledTo(closeBtn, canClose());
				setEnabledTo(openBtn, canOpen());
				setEnabledTo(zoomBtn, canZoom());
				setEnabledTo(unzoomBtn, canUnzoom());
				setEnabledTo(prevBtn, canPrev());
				setEnabledTo(nextBtn, canNext());
				setShownTo(hud, isOpen());
				setChecked(wrapCheck, canWrap());
			}
		});
	</script>
	<style>
		body { margin:0; padding:0; }
	</style>
</head>
<body>
	<button id="open">Open viewer</button>
	<br>
	<button id="close">Close viewer</button>
	<br>
	<button id="prev">prev</button>
	<button id="next">next</button>
	<br>
	<button id="zoom">+</button>
	<button id="unzoom">-</button>
	<br>
	<label><input type="checkbox" id="wrap"> Wrap mode</label>
	<br>
	<div id="hud"></div>
	<img src="img/1.jpg" alt="" />
	<img src="img/2.jpg" alt="" />
	<img src="img/3.jpg" alt="" />
	<img src="img/4.jpg" alt="" />
	<img src="img/5.jpg" alt="" />
	<img src="img/6.jpg" alt="" />
	<img src="img/7.jpg" alt="" />
	<img src="img/8.jpg" alt="" />
	<img src="img/9.jpg" alt="" />
	<img src="img/10.jpg" alt="" />
	<img src="img/11.jpg" alt="" />
	<img src="img/12.jpg" alt="" />
	<img src="img/13.jpg" alt="" />
	<img src="img/14.jpg" alt="" />
	<img src="img/15.jpg" alt="" />
	<img src="img/16.jpg" alt="" />
	<img src="img/17.jpg" alt="" />
</body>
</html>
